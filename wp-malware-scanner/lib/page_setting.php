<?php
require_once ABSPATH . 'wp-content/plugins/wp-malware-scanner/scanner/scan.php';

    // Create the function which does the work
    function wp_malware_scanner_scheduled_event_action() {
        $options = get_option( 'wp_malware_scanner_options_run_status', "idle" );
        update_option( 'wp_malware_scanner_options_run_shed',"Running Now" );
        if ($options == "idle" || $options == "complete" || $options == "called") {
            update_option('wp_malware_scanner_options_run_status', "running");
            $scan = new MalwareScanner();
            $scan->setFlagHideWhitelist(true);
            $scan->setFlagHideOk(true);
            $scan->setFlagDisableStats(true);
            $scan->run(ABSPATH);
            $report_array = $scan->scanReport;
            update_option('wp_malware_scanner_options_run_status', "complete");
            update_option( 'wp_malware_scanner_options_run_shed',time() );
            update_option('wp_malware_scanner_options_run_result', $report_array);
        }
    }

    function wp_malware_scanner_background_single_action() {
        update_option( 'wp_malware_scanner_options_run_shed',time() );

        try {
            wp_malware_scanner_scheduled_event_action();
        } catch (\Throwable $th) {
            error_log($th->getMessage());
            //throw $th;
            update_option('wp_malware_scanner_options_run_status', "complete");
            update_option( 'wp_malware_scanner_options_run_shed',time() );
            update_option('wp_malware_scanner_options_run_result', new scanReport());
        }
        // Unhook the event
        wp_clear_scheduled_hook( 'wp_malware_scanner_background_task' );
    }

    /**
     * Uitlity Funtion
     */
    function add_br($str) {
        $str_length = strlen($str);
        $output = '';
        $current_index = 0;
        while($current_index < $str_length) {
            $output .= substr($str, $current_index, 30) . '<br>';
            $current_index += 30;
        }
        
        return $output;
    }
    function printEmoji($string) {
        if($string == 'ER') {
            return '<span style="color: red; font-size: 12px;">&#x1F534;</span>';
        } elseif($string == 'WL') {
            return '<span style="color: yellow; font-size: 12px;">ü§ê</span>';
        }
    }

    function wp_malware_scanner_home(){

        class wp_malware_scanner {
            public function __construct() {
                $options = get_option( 'wp_malware_scanner_options_run_status', "idle" );
                $run_shed = get_option( 'wp_malware_scanner_options_run_shed', "none" );
                echo '<div class="wrap">';
                echo "<h1>Scanner</h1>";
                
                if ($options == "idle" || $options == "complete" && $options != "called" && $options != "running") {

                    if (isset($_POST["run_now"])) {
                        update_option('wp_malware_scanner_options_run_status', "called");
                        echo "<h3>Scan Called</h3>";
                        $this->startScanNow();
                        //wp_malware_scanner_scheduled_event_action();
                        unset($_POST["run_now"]);
                    }
                    if (isset($_POST["run_live"])) {
                        update_option('wp_malware_scanner_options_run_status', "called");
                        wp_malware_scanner_scheduled_event_action();
                        unset($_POST["run_live"]);
                    }
                    else{
                        echo '<form action="#" method="post">';
                        echo '<input type="hidden" name="run_now" value="ok">';
                        echo '<input type="submit" class="button button-primary" value="Start Scan">';
                        echo '</form>';
                        echo '<br>';
                        echo '<form action="#" method="post">';
                        echo '<input type="hidden" name="run_live" value="ok">';
                        echo '<input type="submit" class="button button-primary" value="Run Now">';
                        echo '</form>';
                    }
                }
                else{
                    echo "<h3>Scan Running..</h3>";
                }

                $array = get_option( 'wp_malware_scanner_options_run_result', new scanReport());

                echo "<p>Scanned: ".$array->filesScanned."</p>";
                echo "<p>Detected: ".$array->malwareCount."</p>";
                echo "<p>Base Dir: ".$array->baseDir."</p>";
                if (!is_null($array->lastRun ) && $array->lastRun != 0) {
                    echo "<p>Last Run: ". date('Y-m-d H:i:s', $array->lastRun)."</p>";
                }
                else{
                    echo "<p>Last Run: None</p>";
                }
                
               

                if (!is_null($run_shed) && $run_shed != "none" && $run_shed != "Running Now") {
                    echo "<p>Sheduled Run: ". date('Y-m-d H:i:s', $run_shed)."</p>";
                }
                elseif ($run_shed == "Running Now"){
                    echo "<p>Sheduled Run: Running Now</p>";
                }
                else{
                    echo "<p>Sheduled Run: Not Sheduled</p>";
                }
 

                echo "<h2>Last Scan Results</h2>";
                echo '<table class="wp-list-table widefat plugins" cellspacing="0">';
                echo '<thead>';
                echo '    <tr>';
                echo '        <th id="columnname0" class="manage-column column-columnname0" scope="col">.</th>';
                echo '        <th id="columnname" class="manage-column column-columnname" scope="col">File</th>';
                echo '        <th id="columnname2" class="manage-column column-columnname2" scope="col">State</th>';
                echo '        <th id="columnname3" class="manage-column column-columnname3" scope="col">Comment</th>';
                echo '        <th id="columnname5" class="manage-column column-columnname4" scope="col">Pattern</th>';
                echo '    </tr>';
                echo '</thead>';
                echo '<tfoot>';
                echo '<tr>';
                echo '        <th class="manage-column column-columnname0 scope="col"></th>';
                echo '        <th class="manage-column column-columnname scope="col"></th>';
                echo '        <th class="manage-column column-columnname2" scope="col"></th>';
                echo '        <th class="manage-column column-columnname3" scope="col"></th>';
                echo '        <th class="manage-column column-columnname4" scope="col"></th>';
                echo '</tr>';
                echo '</tfoot>';
                echo '<tbody id="the-list">';

                foreach($array->scanObjects as $row){
                    if ($row->state != "OK") {
                        $fmt_path = str_replace(ABSPATH,"",$row->path);
                        $fmt_path = add_br($fmt_path);
                        echo "<tr class=\"inactive\" valign=\"top\"><td class=\"column-columnname\">".printEmoji($row->state)."</td><td class=\"column-columnname\">$fmt_path</td><td class=\"column-columnname2\">$row->state</td><td class=\"column-columnname2\">$row->comment</td><td class=\"column-columnname2\">$row->pattern</td></tr>";
                    }
                }

                echo '</tbody>';
                echo '</table>';
                echo '<br>';


                if (isset($_POST["purge_mls_cache"])) {
                    echo "<h3>Purge Plugin Cache - OK</h3>";
                    update_option('wp_malware_scanner_options_run_status', "idle");
                    update_option( 'wp_malware_scanner_options_run_shed',time() );
                    delete_transient('wpMalwareScannerUpdate_cache');
                    update_option('wp_malware_scanner_options_run_result', new scanReport());
                    unset($_POST["purge_mls_cache"]);
                }
                else{
                    echo '<form action="#" method="post">';
                    echo '<input type="hidden" name="purge_mls_cache" value="ok">';
                    echo '<input type="submit" class="button button-primary" value="Purge Plugin Cache">';
                    echo '</form>';
                }

                //Last
                echo '</div>';

            }

            //update_option( 'wp_malware_scanner_options_update_check', "CHECKED" );
            //start task now 
            function startScanNow()
            {
                if ( ! wp_next_scheduled( 'wp_malware_scanner_background_task' ) ) {
                    wp_schedule_single_event( time() , 'wp_malware_scanner_background_task' );
                }                
            }

        }
        new wp_malware_scanner();
    }
?>